"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.deploy = void 0;
const config_1 = require("./config");
const contract_defs_1 = require("../contract-defs");
exports.deploy = async (config) => {
    const Factory__SimpleProxy = contract_defs_1.getContractFactory('Helper_SimpleProxy', config.deploymentSigner);
    const AddressManager = await contract_defs_1.getContractFactory('Lib_AddressManager', config.deploymentSigner).deploy();
    const contractDeployConfig = await config_1.makeContractDeployConfig(config, AddressManager);
    const failedDeployments = [];
    const contracts = {};
    for (const [name, contractDeployParameters] of Object.entries(contractDeployConfig)) {
        if (config.dependencies && !config.dependencies.includes(name)) {
            continue;
        }
        const SimpleProxy = await Factory__SimpleProxy.deploy();
        await AddressManager.setAddress(name, SimpleProxy.address);
        contracts[`Proxy__${name}`] = SimpleProxy;
        try {
            contracts[name] = await contractDeployParameters.factory
                .connect(config.deploymentSigner)
                .deploy(...(contractDeployParameters.params || []));
            await SimpleProxy.setTarget(contracts[name].address);
        }
        catch (err) {
            failedDeployments.push(name);
        }
    }
    for (const [name, contractDeployParameters] of Object.entries(contractDeployConfig)) {
        if (config.dependencies && !config.dependencies.includes(name)) {
            continue;
        }
        if (contractDeployParameters.afterDeploy) {
            await contractDeployParameters.afterDeploy(contracts);
        }
    }
    return {
        AddressManager,
        failedDeployments,
        contracts,
    };
};
//# sourceMappingURL=deploy.js.map